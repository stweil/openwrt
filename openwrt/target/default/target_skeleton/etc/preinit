#!/bin/sh
mount none /proc -t proc
insmod diag
echo 0x01 > /proc/sys/diag
sleep 1
if [ $(cat /proc/sys/reset) = 1 ] ; then
  export FAILSAFE=true
  while :; do { echo $(((X=(X+1)%8)%2)) > /proc/sys/diag; sleep $((X==0)); } done &
else
  mount | grep jffs2 >&-
  if [ $? = 0 ] ; then 
    mtd unlock rootfs
    [ $(cat /proc/mtd | wc -l) = 6 ] && {
      echo 5 > /proc/sys/diag
      mtd unlock OpenWrt
      mtd erase OpenWrt
      jffs2root --move
    }
    mount -o remount,rw /dev/root /
  else
    mtd unlock mtd4
    mount -t jffs2 /dev/mtdblock/4 /jffs
    pivot_root /jffs /jffs/rom
    mount none /dev -t devfs
    mount none /proc -t proc
    umount rom/proc rom/dev
  fi
fi
mount none /tmp -t ramfs
exec /sbin/init
